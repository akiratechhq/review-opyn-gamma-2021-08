{{> partials/splash}}

[TOC]

## Details

- **Client** {{client_name}}
- **Date** {{date}}
- **Lead reviewer** Daniel Luca ([@cleanunicorn](https://twitter.com/cleanunicorn))
- **Reviewers** Daniel Luca ([@cleanunicorn](https://twitter.com/cleanunicorn)), Andrei Simion ([@andreiashu](https://twitter.com/andreiashu))
- **Repository**: [{{project_name}}]({{source_repository}})
- **Commit hash** `{{commit_hash}}`
- **Technologies**
  - Solidity
  - Node.JS

## Issues Summary

| SEVERITY | OPEN  | CLOSED |
| -------- | :---: | :----: |
{{#issues_summary}}
|  {{severity}}  |  {{open}}  |  {{closed}}  |
{{/issues_summary}}

## Executive summary

This report represents the results of the engagement with **{{client_name}}** to review **{{project_name}}**.

The review was conducted over the course of **{{review_period}}** from **{{date_interval}}**. A total of **{{person_days}} person-days** were spent reviewing the code.

### Week 1

During the first week, we started to get familiarized with the code and the project. We reviewed the code from the beginning to the end of the week.

We set up a few meetings throughout the week to discuss the code and learn how to navigate the codebase. We also discussed the project goals and the project scope.

We identified a few minor issues that we presented to the development team. A few of the already implemented and deployed features needed more clarification in terms of how they are currently configured, and how they fit into the overall project.

### Week 2

We continued to keep communication open with the development team while navigating the code and trying out different attack vectors. 

Even though the project has a lot of code, the way it is structured makes it easy to navigate and understand. Some of its parts exist outside of the blockchain context, meaning that they push trusted data into the chain, which then is used to calculate different security parameters.

During the final days of the week we finalized the report and presented it to the client.

## Scope

The initial review focused on the [{{project_name}}]({{source_repository}}) repository, identified by the commit hash `{{commit_hash}}`.

We focused on manually reviewing the codebase, searching for security issues such as, but not limited to, re-entrancy problems, transaction ordering, block timestamp dependency, exception handling, call stack depth limitation, integer overflow/underflow, self-destructible contracts, unsecured balance, use of origin, costly gas patterns, architectural problems, code readability.

**Includes:**
- core/AddressBook.sol
- core/Controller.sol
- core/MarginCalculator.sol
- core/MarginPool.sol
- core/Otoken.sol
- external/callees/PermitCallee.sol
- libs/MarginVault.sol
- other contracts supporting these files

**Excludes:**
- Everything else

## Issues

{{#issues}}

### [{{title}}]({{url}})
![Issue status: {{status}}](https://img.shields.io/static/v1?label=Status&message={{status}}&color={{status_color}}&style=flat-square) ![{{severity}}](https://img.shields.io/static/v1?label=Severity&message={{severity}}&color={{severity_color}}&style=flat-square)

{{{body}}}

---

{{/issues}}

## Artifacts

### Surya

Sūrya is a utility tool for smart contract systems. It provides a number of visual outputs and information about the structure of smart contracts. It also supports querying the function call graph in multiple ways to aid in the manual inspection and control flow analysis of contracts.

<!-- **Contracts Description Table**

```text
surya mdreport report.md Contract.sol
```

-->

**📘 Controller**

***Files Description Table***


| File Name           | SHA-1 Hash                               |
| ------------------- | ---------------------------------------- |
| core/Controller.sol | 66a9209d597b4d4ff528d72730cc3e25af33badc |


***Contracts Description Table***


|    Contract    |           Type           |                             Bases                             |                |                                          |
| :------------: | :----------------------: | :-----------------------------------------------------------: | :------------: | :--------------------------------------: |
|       └        |    **Function Name**     |                        **Visibility**                         | **Mutability** |              **Modifiers**               |
|                |                          |                                                               |                |                                          |
| **Controller** |      Implementation      | Initializable, OwnableUpgradeSafe, ReentrancyGuardUpgradeSafe |                |                                          |
|       └        |  _isNotPartiallyPaused   |                          Internal 🔒                           |                |                                          |
|       └        |    _isNotFullyPaused     |                          Internal 🔒                           |                |                                          |
|       └        |      _isAuthorized       |                          Internal 🔒                           |                |                                          |
|       └        |        initialize        |                          External ❗️                           |       🛑        |               initializer                |
|       └        |          donate          |                          External ❗️                           |       🛑        |                   NO❗️                    |
|       └        | setSystemPartiallyPaused |                          External ❗️                           |       🛑        |            onlyPartialPauser             |
|       └        |   setSystemFullyPaused   |                          External ❗️                           |       🛑        |              onlyFullPauser              |
|       └        |      setFullPauser       |                          External ❗️                           |       🛑        |                onlyOwner                 |
|       └        |     setPartialPauser     |                          External ❗️                           |       🛑        |                onlyOwner                 |
|       └        |    setCallRestriction    |                          External ❗️                           |       🛑        |                onlyOwner                 |
|       └        |       setOperator        |                          External ❗️                           |       🛑        |                   NO❗️                    |
|       └        |   refreshConfiguration   |                          External ❗️                           |       🛑        |                onlyOwner                 |
|       └        |       setNakedCap        |                          External ❗️                           |       🛑        |                onlyOwner                 |
|       └        |         operate          |                          External ❗️                           |       🛑        |       nonReentrant notFullyPaused        |
|       └        |           sync           |                          External ❗️                           |       🛑        |       nonReentrant notFullyPaused        |
|       └        |        isOperator        |                          External ❗️                           |                |                   NO❗️                    |
|       └        |     getConfiguration     |                          External ❗️                           |                |                   NO❗️                    |
|       └        |        getProceed        |                          External ❗️                           |                |                   NO❗️                    |
|       └        |      isLiquidatable      |                          External ❗️                           |                |                   NO❗️                    |
|       └        |        getPayout         |                           Public ❗️                            |                |                   NO❗️                    |
|       └        |   isSettlementAllowed    |                          External ❗️                           |                |                   NO❗️                    |
|       └        |     canSettleAssets      |                          External ❗️                           |                |                   NO❗️                    |
|       └        |  getAccountVaultCounter  |                          External ❗️                           |                |                   NO❗️                    |
|       └        |        hasExpired        |                          External ❗️                           |                |                   NO❗️                    |
|       └        |         getVault         |                          External ❗️                           |                |                   NO❗️                    |
|       └        |   getVaultWithDetails    |                           Public ❗️                            |                |                   NO❗️                    |
|       └        |       getNakedCap        |                          External ❗️                           |                |                   NO❗️                    |
|       └        |   getNakedPoolBalance    |                          External ❗️                           |                |                   NO❗️                    |
|       └        |       _runActions        |                          Internal 🔒                           |       🛑        |                                          |
|       └        |    _verifyFinalState     |                          Internal 🔒                           |                |                                          |
|       └        |        _openVault        |                          Internal 🔒                           |       🛑        |    notPartiallyPaused onlyAuthorized     |
|       └        |       _depositLong       |                          Internal 🔒                           |       🛑        |    notPartiallyPaused onlyAuthorized     |
|       └        |      _withdrawLong       |                          Internal 🔒                           |       🛑        |    notPartiallyPaused onlyAuthorized     |
|       └        |    _depositCollateral    |                          Internal 🔒                           |       🛑        |    notPartiallyPaused onlyAuthorized     |
|       └        |   _withdrawCollateral    |                          Internal 🔒                           |       🛑        |    notPartiallyPaused onlyAuthorized     |
|       └        |       _mintOtoken        |                          Internal 🔒                           |       🛑        |    notPartiallyPaused onlyAuthorized     |
|       └        |       _burnOtoken        |                          Internal 🔒                           |       🛑        |    notPartiallyPaused onlyAuthorized     |
|       └        |         _redeem          |                          Internal 🔒                           |       🛑        |                                          |
|       └        |       _settleVault       |                          Internal 🔒                           |       🛑        |              onlyAuthorized              |
|       └        |        _liquidate        |                          Internal 🔒                           |       🛑        |            notPartiallyPaused            |
|       └        |          _call           |                          Internal 🔒                           |       🛑        | notPartiallyPaused onlyWhitelistedCallee |
|       └        |      _checkVaultId       |                          Internal 🔒                           |                |                                          |
|       └        |       _isNotEmpty        |                          Internal 🔒                           |                |                                          |
|       └        |   _isCalleeWhitelisted   |                          Internal 🔒                           |                |                                          |
|       └        |     _isLiquidatable      |                          Internal 🔒                           |                |                                          |
|       └        |    _getOtokenDetails     |                          Internal 🔒                           |                |                                          |
|       └        |     _canSettleAssets     |                          Internal 🔒                           |                |                                          |
|       └        |  _refreshConfigInternal  |                          Internal 🔒                           |       🛑        |                                          |


**📘 MarginCalculator**

***Files Description Table***


| File Name                 | SHA-1 Hash                               |
| ------------------------- | ---------------------------------------- |
| core/MarginCalculator.sol | 3a4048d34b7a3cf47549e3e4d5b9712e23918f7f |


***Contracts Description Table***


|       Contract       |             Type             |     Bases      |                |               |
| :------------------: | :--------------------------: | :------------: | :------------: | :-----------: |
|          └           |      **Function Name**       | **Visibility** | **Mutability** | **Modifiers** |
|                      |                              |                |                |               |
| **MarginCalculator** |        Implementation        |    Ownable     |                |               |
|          └           |        <Constructor>         |    Public ❗️    |       🛑        |      NO❗️      |
|          └           |      setCollateralDust       |   External ❗️   |       🛑        |   onlyOwner   |
|          └           |     setUpperBoundValues      |   External ❗️   |       🛑        |   onlyOwner   |
|          └           |    updateUpperBoundValue     |   External ❗️   |       🛑        |   onlyOwner   |
|          └           |         setSpotShock         |   External ❗️   |       🛑        |   onlyOwner   |
|          └           |      setOracleDeviation      |   External ❗️   |       🛑        |   onlyOwner   |
|          └           |      getCollateralDust       |   External ❗️   |                |      NO❗️      |
|          └           |       getTimesToExpiry       |   External ❗️   |                |      NO❗️      |
|          └           |         getMaxPrice          |   External ❗️   |                |      NO❗️      |
|          └           |         getSpotShock         |   External ❗️   |                |      NO❗️      |
|          └           |      getOracleDeviation      |   External ❗️   |                |      NO❗️      |
|          └           |    getNakedMarginRequired    |   External ❗️   |                |      NO❗️      |
|          └           |     getExpiredPayoutRate     |   External ❗️   |                |      NO❗️      |
|          └           |        isLiquidatable        |   External ❗️   |                |      NO❗️      |
|          └           |      getMarginRequired       |   External ❗️   |                |      NO❗️      |
|          └           |     getExcessCollateral      |    Public ❗️    |                |      NO❗️      |
|          └           |     _getExpiredCashValue     |   Internal 🔒   |                |               |
|          └           |      _getMarginRequired      |   Internal 🔒   |                |               |
|          └           |   _getNakedMarginRequired    |   Internal 🔒   |                |               |
|          └           |     _findUpperBoundValue     |   Internal 🔒   |                |               |
|          └           | _getPutSpreadMarginRequired  |   Internal 🔒   |                |               |
|          └           | _getCallSpreadMarginRequired |   Internal 🔒   |                |               |
|          └           |  _convertAmountOnLivePrice   |   Internal 🔒   |                |               |
|          └           | _convertAmountOnExpiryPrice  |   Internal 🔒   |                |               |
|          └           |        _getDebtPrice         |   Internal 🔒   |                |               |
|          └           |       _getVaultDetails       |   Internal 🔒   |                |               |
|          └           |  _getExpiredSpreadCashValue  |   Internal 🔒   |                |               |
|          └           |         _isNotEmpty          |   Internal 🔒   |                |               |
|          └           |      _checkIsValidVault      |   Internal 🔒   |                |               |
|          └           |      _isMarginableLong       |   Internal 🔒   |                |               |
|          └           |   _isMarginableCollateral    |   Internal 🔒   |                |               |
|          └           |       _getProductHash        |   Internal 🔒   |                |               |
|          └           |        _getCashValue         |   Internal 🔒   |                |               |
|          └           |      _getOtokenDetails       |   Internal 🔒   |                |               |


**📘 PermitCallee**

***Files Description Table***


| File Name                         | SHA-1 Hash                               |
| --------------------------------- | ---------------------------------------- |
| external/callees/PermitCallee.sol | b98ff2a706037baaa339e0f86e309798092ad81e |


***Contracts Description Table***


|     Contract     |       Type        |      Bases      |                |               |
| :--------------: | :---------------: | :-------------: | :------------: | :-----------: |
|        └         | **Function Name** | **Visibility**  | **Mutability** | **Modifiers** |
|                  |                   |                 |                |               |
| **PermitCallee** |  Implementation   | CalleeInterface |                |               |
|        └         |   callFunction    |   External ❗️    |       🛑        |      NO❗️      |


**📘 MarginVault**

***Files Description Table***


| File Name            | SHA-1 Hash                               |
| -------------------- | ---------------------------------------- |
| libs/MarginVault.sol | 5f067b7b716b0645029104f6de80ba8dcd279418 |


***Contracts Description Table***


|    Contract     |       Type        |     Bases      |                |               |
| :-------------: | :---------------: | :------------: | :------------: | :-----------: |
|        └        | **Function Name** | **Visibility** | **Mutability** | **Modifiers** |
|                 |                   |                |                |               |
| **MarginVault** |      Library      |                |                |               |
|        └        |     addShort      |   External ❗️   |       🛑        |      NO❗️      |
|        └        |    removeShort    |   External ❗️   |       🛑        |      NO❗️      |
|        └        |      addLong      |   External ❗️   |       🛑        |      NO❗️      |
|        └        |    removeLong     |   External ❗️   |       🛑        |      NO❗️      |
|        └        |   addCollateral   |   External ❗️   |       🛑        |      NO❗️      |
|        └        | removeCollateral  |   External ❗️   |       🛑        |      NO❗️      |


***Legend***

| Symbol | Meaning                   |
| :----: | ------------------------- |
|   🛑    | Function can modify state |
|   💵    | Function is payable       |


#### Graphs

**📘 Controller**

**Execution Graph**

![Controller Graph](./static/Controller_graph.png)

**Inheritance**

![Controller Graph](./static/Controller_inheritance.png)

**📘 MarginCalculator**

**Execution Graph**

![MarginCalculator Graph](./static/MarginCalculator_graph.png)

**Inheritance**

![MarginCalculator Graph](./static/MarginCalculator_inheritance.png)

**📘 PermitCallee**

**Execution Graph**

![PermitCallee Graph](./static/PermitCallee_graph.png)

**Inheritance**

![PermitCallee Graph](./static/PermitCallee_inheritance.png)

**📘 MarginVault**

**Execution Graph**

![MarginVault Graph](./static/MarginVault_graph.png)

**Inheritance**

![MarginVault Graph](./static/MarginVault_inheritance.png)


<!-- ***Contract***

```text
surya graph Contract.sol | dot -Tpng > ./static/Contract_graph.png
```

![Contract Graph](./static/Contract_graph.png)

```text
surya inheritance Contract.sol | dot -Tpng > ./static/Contract_inheritance.png
```

![Contract Inheritance](./static/Contract_inheritance.png)

```text
Use Solidity Visual Auditor
```

![Contract UML](./static/Contract_uml.png) -->

#### Describe

**📘 Controller**

```text
$ npx surya describe contracts/core/Controller.sol
 +  Controller (Initializable, OwnableUpgradeSafe, ReentrancyGuardUpgradeSafe)
    - [Int] _isNotPartiallyPaused
    - [Int] _isNotFullyPaused
    - [Int] _isAuthorized
    - [Ext] initialize #
       - modifiers: initializer
    - [Ext] donate #
    - [Ext] setSystemPartiallyPaused #
       - modifiers: onlyPartialPauser
    - [Ext] setSystemFullyPaused #
       - modifiers: onlyFullPauser
    - [Ext] setFullPauser #
       - modifiers: onlyOwner
    - [Ext] setPartialPauser #
       - modifiers: onlyOwner
    - [Ext] setCallRestriction #
       - modifiers: onlyOwner
    - [Ext] setOperator #
    - [Ext] refreshConfiguration #
       - modifiers: onlyOwner
    - [Ext] setNakedCap #
       - modifiers: onlyOwner
    - [Ext] operate #
       - modifiers: nonReentrant,notFullyPaused
    - [Ext] sync #
       - modifiers: nonReentrant,notFullyPaused
    - [Ext] isOperator
    - [Ext] getConfiguration
    - [Ext] getProceed
    - [Ext] isLiquidatable
    - [Pub] getPayout
    - [Ext] isSettlementAllowed
    - [Ext] canSettleAssets
    - [Ext] getAccountVaultCounter
    - [Ext] hasExpired
    - [Ext] getVault
    - [Pub] getVaultWithDetails
    - [Ext] getNakedCap
    - [Ext] getNakedPoolBalance
    - [Int] _runActions #
    - [Int] _verifyFinalState
    - [Int] _openVault #
       - modifiers: notPartiallyPaused,onlyAuthorized
    - [Int] _depositLong #
       - modifiers: notPartiallyPaused,onlyAuthorized
    - [Int] _withdrawLong #
       - modifiers: notPartiallyPaused,onlyAuthorized
    - [Int] _depositCollateral #
       - modifiers: notPartiallyPaused,onlyAuthorized
    - [Int] _withdrawCollateral #
       - modifiers: notPartiallyPaused,onlyAuthorized
    - [Int] _mintOtoken #
       - modifiers: notPartiallyPaused,onlyAuthorized
    - [Int] _burnOtoken #
       - modifiers: notPartiallyPaused,onlyAuthorized
    - [Int] _redeem #
    - [Int] _settleVault #
       - modifiers: onlyAuthorized
    - [Int] _liquidate #
       - modifiers: notPartiallyPaused
    - [Int] _call #
       - modifiers: notPartiallyPaused,onlyWhitelistedCallee
    - [Int] _checkVaultId
    - [Int] _isNotEmpty
    - [Int] _isCalleeWhitelisted
    - [Int] _isLiquidatable
    - [Int] _getOtokenDetails
    - [Int] _canSettleAssets
    - [Int] _refreshConfigInternal #


 ($) = payable function
 # = non-constant function
```

**📘 MarginCalculator**

```text
$ npx surya describe ./core/MarginCalculator.sol 
 +  MarginCalculator (Ownable)
    - [Pub] <Constructor> #
    - [Ext] setCollateralDust #
       - modifiers: onlyOwner
    - [Ext] setUpperBoundValues #
       - modifiers: onlyOwner
    - [Ext] updateUpperBoundValue #
       - modifiers: onlyOwner
    - [Ext] setSpotShock #
       - modifiers: onlyOwner
    - [Ext] setOracleDeviation #
       - modifiers: onlyOwner
    - [Ext] getCollateralDust
    - [Ext] getTimesToExpiry
    - [Ext] getMaxPrice
    - [Ext] getSpotShock
    - [Ext] getOracleDeviation
    - [Ext] getNakedMarginRequired
    - [Ext] getExpiredPayoutRate
    - [Ext] isLiquidatable
    - [Ext] getMarginRequired
    - [Pub] getExcessCollateral
    - [Int] _getExpiredCashValue
    - [Int] _getMarginRequired
    - [Int] _getNakedMarginRequired
    - [Int] _findUpperBoundValue
    - [Int] _getPutSpreadMarginRequired
    - [Int] _getCallSpreadMarginRequired
    - [Int] _convertAmountOnLivePrice
    - [Int] _convertAmountOnExpiryPrice
    - [Int] _getDebtPrice
    - [Int] _getVaultDetails
    - [Int] _getExpiredSpreadCashValue
    - [Int] _isNotEmpty
    - [Int] _checkIsValidVault
    - [Int] _isMarginableLong
    - [Int] _isMarginableCollateral
    - [Int] _getProductHash
    - [Int] _getCashValue
    - [Int] _getOtokenDetails


 ($) = payable function
 # = non-constant function
```

**📘 PermitCallee**

```text
$ npx surya describe ./external/callees/PermitCallee.sol 
 +  PermitCallee (CalleeInterface)
    - [Ext] callFunction #


 ($) = payable function
 # = non-constant function
```

**📘 MarginVault**

```text
$ npx surya describe ./libs/MarginVault.sol
 + [Lib] MarginVault 
    - [Ext] addShort #
    - [Ext] removeShort #
    - [Ext] addLong #
    - [Ext] removeLong #
    - [Ext] addCollateral #
    - [Ext] removeCollateral #


 ($) = payable function
 # = non-constant function
```

## License

This report falls under the terms described in the included [LICENSE](./LICENSE).

{{> partials/features}}
<link rel="stylesheet" href="./style/print.css"/>
